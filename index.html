<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sistema de Votação</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f7f7f7; }
  h1, h2 { color: #333; }
  .hidden { display: none; }
  button { margin-left: 8px; }
  ul { list-style: none; padding-left: 0; }
  li { margin: 8px 0; background: white; padding: 10px; border-radius: 5px; }
</style>
</head>
<body>

<h1>Sistema de Votação</h1>

<div id="loginAdmin">
  <h2>Login do Admin</h2>
  <input type="password" id="senhaAdmin" placeholder="Senha do admin" />
  <button onclick="loginAdmin()">Entrar</button>
</div>

<div id="adminPanel" class="hidden">
  <h2>Painel do Admin</h2>
  <input type="text" id="novoCandidato" placeholder="Nome do candidato" />
  <button onclick="adicionarCandidato()">Adicionar Candidato</button>
  <button onclick="logoutAdmin()">Sair do Admin</button>

  <h3>Candidatos</h3>
  <ul id="listaCandidatosAdmin"></ul>

  <h3>Votantes</h3>
  <ul id="listaVotantes"></ul>
</div>

<h2>Votação</h2>
<ul id="listaCandidatos"></ul>

<script>
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";

const firebaseConfig = {
  apiKey: "AIzaSyBR0RGWG5C8-CVG-RmJVUMEWstKGAVm5ig",
  authDomain: "votacao-pubg.firebaseapp.com",
  databaseURL: "https://votacao-pubg-default-rtdb.firebaseio.com",
  projectId: "votacao-pubg",
  storageBucket: "votacao-pubg.firebasestorage.app",
  messagingSenderId: "578854045975",
  appId: "1:578854045975:web:26fb5c2fcc814ab59b8f52",
  measurementId: "G-TZ8NMYLDZ2"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);

  let isAdmin = false;

  // Funções Admin

  function loginAdmin() {
    const senha = document.getElementById('senhaAdmin').value;
    if (senha === '40028922') {
      isAdmin = true;
      document.getElementById('loginAdmin').classList.add('hidden');
      document.getElementById('adminPanel').classList.remove('hidden');
      carregarCandidatos();
      carregarVotantes();
    } else {
      alert('Senha incorreta!');
    }
  }

  function logoutAdmin() {
    isAdmin = false;
    document.getElementById('loginAdmin').classList.remove('hidden');
    document.getElementById('adminPanel').classList.add('hidden');
  }

  function adicionarCandidato() {
    const nome = document.getElementById('novoCandidato').value.trim();
    if (!nome) {
      alert('Digite o nome do candidato!');
      return;
    }
    db.ref('candidatos/' + nome).set({ votos: 0 });
    document.getElementById('novoCandidato').value = '';
  }

  function removerCandidato(nome) {
    if (!confirm(`Remover o candidato ${nome}?`)) return;
    db.ref('candidatos/' + nome).remove();
    db.ref('votos/' + nome).remove();
    db.ref('votantes').once('value', snapshot => {
      snapshot.forEach(userSnap => {
        if (userSnap.hasChild(nome)) {
          db.ref(`votantes/${userSnap.key}/${nome}`).remove();
        }
      });
    });
  }

  function carregarCandidatos() {
    const ulAdmin = document.getElementById('listaCandidatosAdmin');
    const ulVote = document.getElementById('listaCandidatos');

    db.ref('candidatos').on('value', snapshot => {
      ulAdmin.innerHTML = '';
      ulVote.innerHTML = '';

      const candidatos = snapshot.val() || {};

      Object.entries(candidatos).forEach(([nome, data]) => {
        // Lista admin
        const liAdmin = document.createElement('li');
        liAdmin.textContent = `${nome} - ${data.votos} votos `;
        if (isAdmin) {
          const btnRemover = document.createElement('button');
          btnRemover.textContent = 'Remover';
          btnRemover.onclick = () => removerCandidato(nome);
          liAdmin.appendChild(btnRemover);
        }
        ulAdmin.appendChild(liAdmin);

        // Lista votacao (visitantes)
        const liVote = document.createElement('li');
        liVote.textContent = nome + ' ';
        const btnVotar = document.createElement('button');
        btnVotar.textContent = 'Votar';
        btnVotar.onclick = () => votar(nome);
        liVote.appendChild(btnVotar);
        ulVote.appendChild(liVote);
      });
    });
  }

  function carregarVotantes() {
    const ul = document.getElementById('listaVotantes');
    db.ref('votantes').on('value', snapshot => {
      ul.innerHTML = '';
      if (!isAdmin) return; // garante que só admin veja

      const votantes = snapshot.val() || {};
      Object.entries(votantes).forEach(([nome, votos]) => {
        const li = document.createElement('li');
        const candidatosVotados = Object.keys(votos).join(', ');
        li.textContent = `${nome} votou em: ${candidatosVotados} `;

        const btnRemover = document.createElement('button');
        btnRemover.textContent = 'Remover votante';
        btnRemover.onclick = () => removerVotante(nome);
        li.appendChild(btnRemover);

        ul.appendChild(li);
      });
    });
  }

  function removerVotante(nome) {
    if (!confirm(`Remover votante ${nome} e seus votos?`)) return;
    db.ref('votantes/' + nome).once('value', snap => {
      const votos = snap.val() || {};
      // Diminuir votos dos candidatos votados por esse usuário
      Object.keys(votos).forEach(candidato => {
        const refVoto = db.ref('candidatos/' + candidato + '/votos');
        refVoto.transaction(v => (v || 0) - 1);
      });
      // Remover o votante
      db.ref('votantes/' + nome).remove();
    });
  }

  function votar(nomeCandidato) {
    const nomeVotante = prompt('Digite seu nome para votar:');
    if (!nomeVotante) {
      alert('Nome obrigatório para votar!');
      return;
    }
    const nomeVotanteTrim = nomeVotante.trim();
    if (!nomeVotanteTrim) {
      alert('Nome inválido!');
      return;
    }

    const refVotanteCandidato = db.ref(`votantes/${nomeVotanteTrim}/${nomeCandidato}`);

    refVotanteCandidato.once('value').then(snapshot => {
      if (snapshot.exists()) {
        alert(`Você já votou no ${nomeCandidato}!`);
      } else {
        // Incrementa votos no candidato
        const refCandidatoVotos = db.ref(`candidatos/${nomeCandidato}/votos`);
        refCandidatoVotos.transaction(v => (v || 0) + 1);

        // Marca o voto na lista de votantes
        refVotanteCandidato.set(true);
        alert(`Voto no ${nomeCandidato} registrado com sucesso!`);
      }
    });
  }

  // Inicializa a lista ao carregar
  carregarCandidatos();

</script>

</body>
</html>
